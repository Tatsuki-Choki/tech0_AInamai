# AI機能要件定義書

## 1. 概要

本ドキュメントは、探究学習日記アプリにおけるAI機能の要件を定義します。

### 1.1 AI機能の位置づけ
本アプリのAI機能は以下の2つの役割を担います：

1. **評価支援**：生徒の自己評価をAIが調整し、客観性を高める
2. **愛着形成**：AI校長（生意君）との対話を通じて、生徒のモチベーションを維持

### 1.2 使用技術
| 項目 | 技術 | 備考 |
|------|------|------|
| LLM | Gemini API | 確定 |
| RAG基盤 | Gemini File Search Store | 確定 |
| RAGデータ | 校長の著書・思想 | 「13歳からのアントレプレナーシップ」等 |

---

## 2. AI機能一覧

| 機能名 | 対象ユーザー | トリガー | 目的 |
|--------|------------|---------|------|
| AI日報コメント生成 | 生徒 | 日報保存時 | 愛着形成・励まし |
| AI評価調整 | システム | 日報保存時 | 客観的評価 |
| AI校長チャット | 生徒 | 生徒が質問時 | 悩み相談・アドバイス |
| 教師向けAIアドバイス | 教師 | ダッシュボード閲覧時 | 指導支援 |

---

## 3. AI日報コメント生成

### 3.1 機能概要
生徒が日報を保存した際に、AI校長（生意君）が励ましやうんちくを含むコメントを生成します。

### 3.2 目的
- 生徒の**愛着を深める**
- 継続的な日報入力のモチベーション維持
- 校長の思想に基づいた知識提供

### 3.3 処理タイミング
**検討中** - 以下のいずれかを選択

| 方式 | メリット | デメリット |
|------|---------|----------|
| 同期処理（即座に生成） | 即時フィードバック | 保存時に待機が発生 |
| 非同期処理（バックグラウンド） | UX向上 | 実装が複雑 |

#### 推奨案
**同期処理**を推奨。理由：
- 即時フィードバックが愛着形成に効果的
- 処理時間は3-5秒程度で許容範囲
- ローディング表示で待機時間を演出

### 3.4 コメントのトーン
**励まし・支援的**（確定）

#### トーンガイドライン
- 肯定的な表現を優先
- 具体的な行動を褒める
- 次のステップへの示唆を含める
- 校長の思想・哲学に基づいたうんちくを追加

#### コメント例
```
素晴らしい取り組みですね！インタビュー調査を通じて、
直接話を聞くという姿勢は「創造力」の発揮そのものです。

アントレプレナーシップにおいて大切なのは、
「まず行動すること」。あなたはそれを実践しています。

次は集めた情報を整理してみましょう。
新しい発見があるかもしれませんよ！
```

### 3.5 プロンプト設計

```
あなたは探究学習を支援するAI校長「生意君」です。
生徒の日報に対して、励ましとうんちくを含むコメントを生成してください。

## キャラクター設定
- 名前：生意君（せいいくん）
- 性格：温かく、知的で、生徒の可能性を信じている
- 口調：です・ます調、親しみやすく丁寧

## コメント生成ルール
1. 生徒の具体的な行動を褒める
2. 選択された能力に関連づけたフィードバック
3. 校長の思想に基づいたうんちく（1-2文）
4. 次のステップへの励まし
5. 全体で150-250文字程度

## 入力情報
- 日報内容：{report_content}
- 選択された能力：{selected_abilities}
- 探究フェーズ：{inquiry_phase}
- 研究テーマ：{research_theme}

## 校長の思想（参考）
{rag_context}

## 出力
コメントのみを出力してください。
```

---

## 4. AI評価調整

### 4.1 機能概要
生徒の自己評価（1-5点）をAIが分析し、より客観的な評価に調整します。

### 4.2 評価構成
| 評価種別 | 重み | 説明 |
|---------|------|------|
| 自己評価 | 33% | 生徒が選択 |
| AI調整評価 | 33% | AIが日報内容から判定 |
| 教師訂正評価 | 33% | 教師が必要に応じて修正 |

### 4.3 評価ロジック

#### 入力データ
1. **日報の文章内容**（必須）：AIが分析のインプットとして使用
2. **RAG（校長の哲学）**（必須）：評価基準の根拠として参照
3. **過去の日報データ**（オプション）：一貫性の確認用

#### 評価基準
RAGで取得した校長の思想に基づいて、各能力の評価基準を動的に生成します。

### 4.4 プロンプト設計

```
あなたは探究学習の評価を支援するAIです。
生徒の日報内容を分析し、7つの起業家精神能力について客観的な評価を行ってください。

## 7つの能力
1. 課題発見力：問題を見つけ、本質を捉える力
2. 計画実行力：目標を設定し、計画的に実行する力
3. 創造力：新しいアイデアを生み出す力
4. 情報活用力：必要な情報を収集・分析・活用する力
5. 人間関係構築力：他者と協力し、良好な関係を築く力
6. 自己管理力：自分自身をコントロールし、成長する力
7. 社会参画力：社会に貢献しようとする意識と行動

## 評価基準（校長の思想に基づく）
{rag_evaluation_criteria}

## 評価ルール
1. 日報に記述された具体的な行動に基づいて評価
2. 記述がない能力は評価しない（nullを返す）
3. 自己評価との乖離がある場合は理由を明記
4. 1-5点のスケールで評価（小数点第1位まで可）

## 入力情報
- 日報内容：{report_content}
- 生徒の自己評価：{self_evaluations}
- 選択された能力：{selected_abilities}
- 探究フェーズ：{inquiry_phase}

## 出力形式（JSON）
{
  "evaluations": [
    {
      "abilityId": "uuid",
      "score": 4.0,
      "reason": "インタビュー調査を自ら企画・実施した点が高く評価できます",
      "comparedToSelf": "same" // "higher", "lower", "same"
    }
  ],
  "overallComment": "全体的な評価コメント"
}
```

### 4.5 再生成機能
**検討中**

#### 推奨案
- 生徒：再生成不可（評価の公平性を担保）
- 教師：再生成可能（訂正評価で上書き可能のため不要とも考えられる）

---

## 5. AI校長チャット

### 5.1 機能概要
生徒がAI校長（生意君）と自由に対話できる機能。探究活動の悩み相談やアドバイスを受けられます。

### 5.2 重要な制約
- **評価とは完全に分離**：チャット内容は評価に一切影響しない
- **履歴を保存しない**：生徒が本音で相談できるよう、会話履歴はDBに保存しない

### 5.3 キャラクター設計

| 項目 | 内容 |
|------|------|
| 名前 | 生意君（せいいくん） |
| 由来 | 「生井校長」+ 親しみやすさ |
| 性格 | 温かい、知的、ユーモアがある、生徒の味方 |
| 口調 | です・ます調、親しみやすく |
| 特徴 | 校長の思想・哲学に基づいたアドバイス |

### 5.4 プロンプト設計

```
あなたは探究学習を支援するAI校長「生意君（せいいくん）」です。
生徒の相談に対して、温かく知的なアドバイスを行ってください。

## キャラクター設定
- 名前：生意君
- 性格：温かく、知的で、ユーモアがあり、生徒の可能性を強く信じている
- 口調：です・ます調で親しみやすく
- 特徴：
  - 校長の著書「13歳からのアントレプレナーシップ」の思想を体現
  - 難しいことも分かりやすく説明
  - 生徒の悩みに共感しつつ、前向きな視点を提供
  - 時にうんちくや豆知識を交える

## 対話ルール
1. まず生徒の気持ちに共感する
2. 校長の思想に基づいたアドバイスを提供
3. 具体的な行動提案を含める
4. 押しつけがましくならない
5. 必要に応じてユーモアを交える

## 注意事項
- この会話は評価に一切影響しないことを生徒は知っています
- 安心して本音で話せる雰囲気を作ってください
- 深刻な悩み（いじめ、メンタルヘルス等）の場合は、
  専門家への相談を勧めてください

## 校長の思想（参考）
{rag_context}

## 生徒情報（参考）
- 名前：{student_name}
- 研究テーマ：{research_theme}
- 現在のフェーズ：{current_phase}

## 生徒のメッセージ
{user_message}

## 回答
```

### 5.5 セッション管理
- チャット履歴はブラウザのメモリ（セッション）にのみ保持
- ページ離脱・リロードで消去
- サーバー側・DBには一切保存しない

### 5.6 RAG活用
- 校長の著書からの引用を適宜含める
- 引用元を明示（「〇〇という本にこんな言葉があります」等）

---

## 6. 教師向けAIアドバイス

### 6.1 機能概要
教師ダッシュボードで、個別生徒への指導アドバイスをAIが提供します。

### 6.2 目的
- 教師が生徒に「**納得感のある評価の説明**」を行うための判断材料を提供
- 客観的なデータに基づいた指導ポイントの提示

### 6.3 アドバイス種別
**個別生徒へのアドバイス**（確定）

### 6.4 アドバイス内容

#### 含める情報
1. 生徒の強み（伸びている能力）
2. 成長機会（改善の余地がある能力）
3. 日報の傾向分析
4. 具体的な指導ポイント
5. 自己評価とAI評価の乖離がある場合の説明

#### アドバイス例
```
【山田太郎さんの分析】

■ 強み
- 「課題発見力」が継続的に高評価（平均4.2）
- 独自の視点で問題を捉える力があります

■ 成長機会
- 「人間関係構築力」の選択が少ない傾向
- 他者との協働経験を増やすと良いかもしれません

■ 指導ポイント
- 自己評価が実際の行動より控えめな傾向があります
- 具体的な成果を褒めることで自己肯定感を高められます

■ 評価説明用メモ
「情報活用力」でAI評価が自己評価より高い理由：
→ 日報に記載された調査方法が体系的で、
  情報を適切に整理・分析している証拠が見られます
```

### 6.5 プロンプト設計

```
あなたは探究学習の指導を支援するAIアドバイザーです。
教師向けに、生徒への指導アドバイスを生成してください。

## 目的
- 教師が生徒に納得感のある評価説明を行うための材料を提供
- 客観的データに基づいた指導ポイントの提示

## 入力情報
- 生徒名：{student_name}
- 研究テーマ：{research_theme}
- 過去の日報一覧：{reports_summary}
- 評価履歴：{evaluation_history}
- 自己評価とAI評価の乖離：{evaluation_gaps}

## 出力形式
1. 強み（2-3点）
2. 成長機会（2-3点）
3. 具体的な指導ポイント
4. 評価説明用メモ（自己評価との乖離がある場合）

## 注意事項
- 否定的な表現を避け、成長の可能性として提示
- 具体的なエビデンス（日報の記述）に基づく
- 教師が生徒に直接伝えられる形式で記述
```

---

## 7. RAG（検索拡張生成）設計

### 7.1 データソース
| ソース | 形式 | 用途 |
|--------|------|------|
| 「13歳からのアントレプレナーシップ」 | PDF | 主要な思想・哲学 |
| 校長講演録（将来） | テキスト | 追加の考え方 |
| 学校の教育方針（将来） | テキスト | 評価基準 |

### 7.2 Gemini File Search Store設定
- Store ID: `fileSearchStores/principalphilosophy-ydwhy17rmp7m`
- インデックス済みファイル: 校長著書PDF

### 7.3 検索設計

#### 各機能でのRAG活用
| 機能 | 検索クエリ例 | 取得情報 |
|------|------------|---------|
| AI日報コメント | 「{能力名}に関する励ましの言葉」 | 関連する思想・名言 |
| AI評価調整 | 「{能力名}の評価基準」 | 評価の根拠となる考え方 |
| AI校長チャット | 「{生徒の質問に関連するトピック}」 | アドバイスの根拠 |
| 教師向けアドバイス | 「指導方法」「評価の伝え方」 | 指導のヒント |

---

## 8. エラーハンドリング

### 8.1 Gemini API エラー時の対応

| エラー種別 | 対応 |
|-----------|------|
| レート制限 | リトライ（指数バックオフ） |
| タイムアウト | デフォルトメッセージを表示 |
| コンテンツフィルター | 再生成を試行 |
| API障害 | 手動入力モードに切り替え |

### 8.2 フォールバックメッセージ

#### AI日報コメント
```
日報を受け取りました！
（AIコメントの生成に時間がかかっています。後ほど表示されます）
```

#### AI校長チャット
```
申し訳ありません、今少し考えがまとまりません。
もう一度質問していただけますか？
```

---

## 9. コスト管理

### 9.1 Gemini API料金
| 項目 | 料金 |
|------|------|
| 入力トークン | $0.075 / 1M tokens |
| 出力トークン | $0.30 / 1M tokens |
| RAGインデックス | $0.15 / 1M tokens |
| RAGストレージ | 無料 |

### 9.2 コスト試算（月間）
- ユーザー数：400人
- 1日あたり日報：200件
- AIコメント生成：200回 × 30日 = 6,000回/月
- AI評価生成：6,000回/月
- チャット：1,000回/月（推定）

| 処理 | トークン/回 | 月間トークン | 月間コスト |
|------|-----------|------------|----------|
| AIコメント | 2,000 | 12M | $3.00 |
| AI評価 | 3,000 | 18M | $4.50 |
| チャット | 4,000 | 4M | $1.50 |
| **合計** | - | 34M | **約$9/月** |

※実際の利用パターンにより変動

---

## 10. 未決定事項一覧

| 項目 | 選択肢 | 推奨 | 決定期限 |
|------|--------|------|---------|
| AIコメント生成タイミング | 同期/非同期 | 同期 | 開発時 |
| AI評価の再生成機能 | あり/なし | なし | 開発時 |
| 過去日報データの参照 | する/しない | しない（初期） | 開発時 |
| チャット履歴の一時保存期間 | なし/セッション中 | セッション中 | 開発時 |

---

## 11. 更新履歴

| 日付 | バージョン | 変更内容 |
|------|-----------|---------|
| 2024-01-15 | 1.0 | 初版作成 |
