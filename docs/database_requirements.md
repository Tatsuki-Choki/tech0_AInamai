# データベース要件定義書

## 1. 概要

本ドキュメントは、探究学習日記アプリのデータベース設計に関する要件をまとめたものです。

### 1.1 アプリの目的

- 生徒の探究学習の進捗状況を日々記録・蓄積
- **過程を含めた評価**を可能にする
- 生徒と教師の間で生じていた評価のミスマッチを解消
- 教師の評価をサポートし、判断基準となる情報を提供

### 1.2 ターゲットユーザー

- **生徒**: 探究学習に前向きな生徒
- **教師**: 生徒の評価・指導を行う教師

### 1.3 想定規模

| 項目 | 内容 |
|------|------|
| 対象校 | 下妻第一高校（現時点） |
| 想定生徒数 | 300〜400人程度 |
| 初期ターゲット | 探究学習に力を入れたい生徒（一部） |

---

## 2. ユーザー管理

### 2.1 ユーザーの種別

| 種別 | 説明 |
|------|------|
| 生徒 | 日々の探究学習を報告するユーザー |
| 教師 | 生徒の進捗確認・評価を行うユーザー |

### 2.2 生徒と教師の関係性

| 項目 | 内容 |
|------|------|
| 関係性 | **多対多** |
| 主担当（担任） | 存在する（訂正評価の権限を持つ） |
| 閲覧権限 | 柔軟に設定可能な構造 |

#### 背景

- 探究学習は特定のクラスや学年を超えた活動として行われる可能性がある
- 「マーケティングゼミ」のように複数の教師が生徒の指導に関わるケースがある
- 担任の先生の評価（訂正評価）が33%のウェイトを持つため、主担当の概念が必要

### 2.3 認証方式

- **Google認証**によるログイン
- ログイン後、生徒側と教師側で画面を切り分け

---

## 3. 探究テーマ

### 3.1 基本仕様

| 項目 | 内容 |
|------|------|
| テーマ数 | 1人の生徒につき**1つのみ** |
| 期間 | **年度単位**（年度をまたがない） |
| 変更 | 可能（ただし基本的には固定運用を想定） |

### 3.2 保存する属性

| 属性 | 説明 |
|------|------|
| テーマ名 | 探究テーマのタイトル |
| 詳細説明 | テーマの詳細な説明 |
| 設定日 | テーマを設定した日付 |
| ステータス | 進行中 / 完了 など |
| 年度 | 対象年度 |

---

## 4. 日々の報告（日記）

### 4.1 報告フロー

```
1. 生徒が進捗報告文を入力
      ↓
2. 生徒が7つの能力（複数可）と探究フェーズを選択
      ↓
3. 送信
      ↓
4. AIから一言コメントが返る（評価とは独立）
      ↓
5. 選択回数がカウントアップされ評価データに蓄積
```

### 4.2 報告の基本仕様

| 項目 | 内容 |
|------|------|
| 報告頻度 | 1日**複数回可能**（原則1回を想定） |
| 能力選択数 | **複数選択可能**（上限なし） |
| 未選択 | 可能（その場合スコア貢献はゼロ） |
| 編集 | **可能**（振り返り画面から編集） |

### 4.3 保存する属性

| 属性 | 説明 |
|------|------|
| 報告内容（原文） | 生徒が入力した進捗報告テキスト |
| 選択した能力 | 7つの能力から選択されたもの（複数可） |
| 選択した探究フェーズ | 4つのフェーズから1つ |
| AIコメント | AIからの一言コメント |
| 報告日時 | 報告した日時 |
| 更新日時 | 編集時の更新日時 |

### 4.4 7つの能力（マスタ管理）

将来的な追加・変更の可能性を考慮し、**マスタテーブルで管理**する。

| # | 能力名 | 説明 |
|---|--------|------|
| 1 | 情報収集能力と先を見る力 | トレンドを感知し、未来を予測する力 |
| 2 | 課題設定能力と構想する力 | 課題を設定し、構想を練る力 |
| 3 | 巻き込む力 | 他人を巻き込み、協力を得る力 |
| 4 | 対話する力 | 対話を通じて相手を理解する力 |
| 5 | 実行する力 | 小さなことから始め、実行に移す力 |
| 6 | 謙虚である力 | 謙虚な姿勢で仲間を集める力 |
| 7 | 完遂する力 | 諦めずにやり遂げる力 |

### 4.5 探究フェーズ（マスタ管理）

将来的な追加・変更の可能性を考慮し、**マスタテーブルで管理**する。

| # | フェーズ名 |
|---|-----------|
| 1 | 課題の設定 |
| 2 | 情報の収集 |
| 3 | 整理・分析 |
| 4 | まとめ・表現 |

---

## 5. 評価システム

### 5.1 評価の基本方針

| 項目 | 内容 |
|------|------|
| 評価単位 | 日々の積み上げ + 定期的なまとめ評価 |
| 評価方式 | **単純カウントアップ**（1選択=1ポイント） |
| メイン/サブ区別 | **なし**（簡素化により廃止） |

### 5.2 4パターンの評価

従来の担任教師による評価が100%だった状態から、3つの視点を取り入れ、評価の納得感と公平性を高める。

| パターン | 説明 | ウェイト |
|----------|------|----------|
| 生徒の自己評価 | 生徒が選択した能力のカウント | 33% |
| AIによる調整後評価 | 校長思想に基づく定量評価軸で調整 | 33% |
| 教師による訂正評価 | 学習指導要領のルーブリックに基づく訂正 | 33% |
| **最終評価** | 上記3つを按分して算出 | 100% |

### 5.3 評価データの保存

| 属性 | 説明 |
|------|------|
| 能力別カウント | 7つの能力 × 選択回数 |
| フェーズ別カウント | 4つのフェーズ × 選択回数 |
| 継続日数 | 連続報告日数 |
| AI調整評価 | AIが算出した評価点・コメント |
| 教師訂正評価 | 教師が入力した訂正評価・コメント |
| 最終評価 | 按分後の総合評価 |

### 5.4 生徒への表示制限

| 項目 | 生徒への表示 |
|------|-------------|
| 具体的な評価点数（スコア） | **非表示**（ハック行為防止） |
| 継続記録 | 表示（「○日連続達成」など） |

### 5.5 継続記録

| 項目 | 内容 |
|------|------|
| カウント方法 | **連続日数**（1日空くとリセット） |
| 休日・長期休暇 | 報告可能（カウント対象に含む） |
| 表示情報 | 「○日連続達成」 |

---

## 6. AI校長チャットボット

### 6.1 基本仕様

| 項目 | 内容 |
|------|------|
| 位置づけ | 評価機能とは**完全に分離** |
| 目的 | 生徒のアプリへの愛着向上、相談相手 |
| 知識基盤 | 校長の著書・思想（RAG） |

### 6.2 記録・制限

| 項目 | 内容 |
|------|------|
| 記録保存 | **完全に保存しない** |
| 教師への共有 | なし |
| 利用制限 | 特になし（自由に会話可能） |
| 会話の文脈 | 探究テーマ・過去報告は**参照しない** |

### 6.3 想定される利用シーン

- 報告のヒントを得る
- 「巻き込む力ってどういう能力？」といった質問
- 個人的な相談（恋愛相談なども可）

### 6.4 RAG基盤

| 項目 | 内容 |
|------|------|
| 格納先 | Gemini File Search Store |
| Store ID | `fileSearchStores/principalphilosophy-ydwhy17rmp7m` |
| アップロード済みデータ | 「13歳からのアントレプレナーシップ」PDF |

---

## 7. 教師側ダッシュボード

### 7.1 閲覧可能なデータ

| データ項目 | 閲覧可否 |
|-----------|---------|
| 担当生徒の一覧 | ○ |
| 各生徒の探究テーマ | ○ |
| 各生徒の日々の報告内容（原文） | ○ |
| 各生徒の能力別カウント | ○ |
| 各生徒の探究フェーズ別カウント | ○ |
| 継続日数 | ○ |
| 4パターンの評価 | ○ |

### 7.2 入力・編集可能なデータ

| データ項目 | 説明 |
|-----------|------|
| 訂正評価 | 教師なりの視点による訂正（ルーブリック基準） |
| フィードバックコメント | 生徒への具体的な改善ポイント・説明 |

### 7.3 AIからの指導支援アドバイス

| 項目 | 内容 |
|------|------|
| 生成タイミング | 自動生成 または 教師リクエスト時 |
| 内容 | 生徒の状況に基づく指導アドバイス |
| 目的 | 評価の根拠説明、生徒への納得感ある説明をサポート |

---

## 8. 年度・期間管理

### 8.1 年度定義

| 項目 | 内容 |
|------|------|
| 年度 | **4月〜翌3月**（日本の学校年度） |
| 探究テーマの期間 | 年度単位（年度またぎなし） |

### 8.2 評価期間

| 項目 | 内容 |
|------|------|
| 基礎データ | 日々の積み上げ |
| 可視化タイミング | 学期ごと、年度末など |

### 8.3 過去データの閲覧

| ユーザー | 閲覧可否 | 目的 |
|----------|---------|------|
| 生徒 | **可能** | 受験・就活での活用 |
| 教師 | **可能** | 長期的な成長把握 |

### 8.4 データ保持

| 項目 | 内容 |
|------|------|
| 卒業後のデータ | **保持する**（受験・就活での活用のため） |
| 保持期間 | 未定（要検討） |

---

## 9. セキュリティ・プライバシー

### 9.1 データの機密性

| 項目 | 対応 |
|------|------|
| 評価点数 | 教師のみ閲覧可能（生徒には非表示） |
| 報告原文 | 教師は閲覧可能 |
| AI校長チャット | 完全に保存しない（プライバシー保護） |

### 9.2 ハック行為の防止

- 生徒には具体的なスコアを表示しない
- 継続記録のみ表示することで、点数稼ぎの動機を抑制

---

## 10. インフラ・技術要件

### 10.1 インフラ環境

| 項目 | 内容 |
|------|------|
| クラウド | **Azure** |
| フロントエンド | Azure上で構築 |
| バックエンド | Azure上で構築 |
| データベース | Azure上で構築 |

### 10.2 AI基盤

| 項目 | 内容 |
|------|------|
| LLM | Gemini API |
| RAG | Gemini File Search Store |
| モデル | gemini-2.5-flash（推奨） |

---

## 11. データモデル（案）

### 11.1 エンティティ一覧

```
┌─────────────────┐
│     User        │
│  (生徒/教師)     │
└────────┬────────┘
         │
    ┌────┴────┐
    │         │
┌───▼───┐ ┌───▼───┐
│Student│ │Teacher│
└───┬───┘ └───┬───┘
    │         │
    └────┬────┘
         │
┌────────▼────────┐
│ StudentTeacher  │
│   (多対多)       │
│ ・主担当フラグ   │
└─────────────────┘

┌─────────────────┐
│ ResearchTheme   │
│  (探究テーマ)    │
└────────┬────────┘
         │
┌────────▼────────┐
│    Report       │
│   (日々の報告)   │
├─────────────────┤
│ ReportAbility   │
│ (報告×能力)     │
└─────────────────┘

┌─────────────────┐
│   Evaluation    │
│     (評価)      │
└─────────────────┘

┌─────────────────┐
│    Ability      │
│  (7つの能力)    │
└─────────────────┘

┌─────────────────┐
│ ResearchPhase   │
│  (探究フェーズ)  │
└─────────────────┘

┌─────────────────┐
│  StreakRecord   │
│  (継続記録)      │
└─────────────────┘
```

### 11.2 主要テーブル構成（暫定）

#### Users
| カラム | 型 | 説明 |
|--------|-----|------|
| id | UUID | 主キー |
| email | String | メールアドレス（Google認証） |
| name | String | 氏名 |
| role | Enum | student / teacher |
| created_at | DateTime | 作成日時 |
| updated_at | DateTime | 更新日時 |

#### Students（Usersの拡張）
| カラム | 型 | 説明 |
|--------|-----|------|
| id | UUID | 主キー |
| user_id | UUID | FK to Users |
| grade | Int | 学年 |
| class | String | クラス |
| fiscal_year | Int | 年度 |

#### Teachers（Usersの拡張）
| カラム | 型 | 説明 |
|--------|-----|------|
| id | UUID | 主キー |
| user_id | UUID | FK to Users |
| department | String | 担当教科など |

#### StudentTeachers（多対多リレーション）
| カラム | 型 | 説明 |
|--------|-----|------|
| id | UUID | 主キー |
| student_id | UUID | FK to Students |
| teacher_id | UUID | FK to Teachers |
| is_primary | Boolean | 主担当フラグ |
| fiscal_year | Int | 年度 |

#### ResearchThemes（探究テーマ）
| カラム | 型 | 説明 |
|--------|-----|------|
| id | UUID | 主キー |
| student_id | UUID | FK to Students |
| title | String | テーマ名 |
| description | Text | 詳細説明 |
| fiscal_year | Int | 年度 |
| status | Enum | in_progress / completed |
| created_at | DateTime | 設定日 |
| updated_at | DateTime | 更新日時 |

#### Reports（日々の報告）
| カラム | 型 | 説明 |
|--------|-----|------|
| id | UUID | 主キー |
| student_id | UUID | FK to Students |
| theme_id | UUID | FK to ResearchThemes |
| content | Text | 報告内容（原文） |
| phase_id | UUID | FK to ResearchPhases |
| ai_comment | Text | AIからの一言コメント |
| reported_at | DateTime | 報告日時 |
| created_at | DateTime | 作成日時 |
| updated_at | DateTime | 更新日時 |

#### ReportAbilities（報告×能力の中間テーブル）
| カラム | 型 | 説明 |
|--------|-----|------|
| id | UUID | 主キー |
| report_id | UUID | FK to Reports |
| ability_id | UUID | FK to Abilities |

#### Abilities（7つの能力マスタ）
| カラム | 型 | 説明 |
|--------|-----|------|
| id | UUID | 主キー |
| name | String | 能力名 |
| description | Text | 説明 |
| display_order | Int | 表示順 |
| is_active | Boolean | 有効フラグ |
| created_at | DateTime | 作成日時 |
| updated_at | DateTime | 更新日時 |

#### ResearchPhases（探究フェーズマスタ）
| カラム | 型 | 説明 |
|--------|-----|------|
| id | UUID | 主キー |
| name | String | フェーズ名 |
| display_order | Int | 表示順 |
| is_active | Boolean | 有効フラグ |
| created_at | DateTime | 作成日時 |
| updated_at | DateTime | 更新日時 |

#### StreakRecords（継続記録）
| カラム | 型 | 説明 |
|--------|-----|------|
| id | UUID | 主キー |
| student_id | UUID | FK to Students |
| current_streak | Int | 現在の連続日数 |
| max_streak | Int | 最長連続日数 |
| last_report_date | Date | 最終報告日 |
| updated_at | DateTime | 更新日時 |

#### Evaluations（評価）
| カラム | 型 | 説明 |
|--------|-----|------|
| id | UUID | 主キー |
| student_id | UUID | FK to Students |
| fiscal_year | Int | 年度 |
| period | String | 評価期間（学期など） |
| self_score | JSON | 自己評価（能力別カウント） |
| ai_score | JSON | AI調整評価 |
| ai_comment | Text | AIからの評価コメント |
| teacher_score | JSON | 教師訂正評価 |
| teacher_comment | Text | 教師からのフィードバック |
| final_score | JSON | 最終評価 |
| evaluated_by | UUID | FK to Teachers（評価した教師） |
| created_at | DateTime | 作成日時 |
| updated_at | DateTime | 更新日時 |

---

## 12. 未決定事項・今後の検討項目

- [ ] 教師の訂正評価の具体的な入力形式（点数のみ？コメント必須？）
- [ ] 評価期間の具体的な区切り（学期ごと？月ごと？）
- [ ] AIからの指導支援アドバイスの生成タイミングの詳細
- [ ] 年度更新時のデータ移行・アーカイブ方針
- [ ] 生徒の学年・クラス変更時の処理
- [ ] 報告データの削除可否
- [ ] アカウント削除時のデータ処理方針
- [ ] データ保持期間の具体的な年数

---

## 更新履歴

| 日付 | 内容 |
|------|------|
| 2025-12-08 | 初版作成 |
| 2025-12-08 | 年度・期間管理、セキュリティ、インフラ要件を追加 |
